<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Uniffle - New chapter for the shuffle in the cloud native era | Apache Uniffle (Incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://uniffle.apache.org/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Uniffle - New chapter for the shuffle in the cloud native era | Apache Uniffle (Incubating)"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-07-21T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://uniffle.apache.org/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era"><link data-rh="true" rel="alternate" href="https://uniffle.apache.org/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era" hreflang="en"><link data-rh="true" rel="alternate" href="https://uniffle.apache.org/zh-CN/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://uniffle.apache.org/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Uniffle (Incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Uniffle (Incubating) Atom Feed"><link rel="stylesheet" href="/assets/css/styles.c92a85d1.css">
<link rel="preload" href="/assets/js/runtime~main.3cf157ce.js" as="script">
<link rel="preload" href="/assets/js/main.1b249127.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/uniffle-logo.png" alt="Apache Uniffle (Incubating)" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/uniffle-logo.png" alt="Apache Uniffle (Incubating)" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Apache Uniffle (Incubating)</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/community/how to contribute">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/policies/privacy.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-CN/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-CN">简体中文</a></li></ul></div><a href="https://github.com/apache/incubator-uniffle" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2023/07/21/Uniffle - New chapter for the shuffle in the cloud native era">Uniffle - New chapter for the shuffle in the cloud native era</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2023/01/09/2022 summary">2022 summary</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">Uniffle - New chapter for the shuffle in the cloud native era</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-07-21T00:00:00.000Z" itemprop="datePublished">July 21, 2023</time> · <!-- -->14 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2><p>Shuffle is the process in distributed computing frameworks used to redistribute data between upstream and downstream tasks. It is a crucial component within computing frameworks and directly impacts their performance and stability.
However, with the exploration of cloud-native architectures, traditional shuffle solutions have revealed various issues. </p><p>In a cloud-native architecture, with use of techniques such as the separation of storage and compute, mixed deployment.The computational nodes have relatively low disk volume, poor IO performance, and an imbalance between CPU and IO resources.
Additionally, computational nodes could be preempted by high-priority jobs due to mixed deployments.</p><p>In traditional Shuffle implementations, shuffle nodes tightly coupled with computational nodes. However, due to the different resource requirements for disk, memory and CPU between computational nodes and shuffle nodes, it is challenging to independently scale them based on their resource needs.
By separating the computational nodes from shuffle nodes, the computational node&#x27;s state becomes more lightweight after offloading the Shuffle state to shuffle nodes, reducing the job recomputation when computational nodes are preempted. </p><p>Decoupling computational and Shuffle nodes also reduces the demand for disk specifications on computational nodes, enabling an increase in the number of accessible computational nodes.</p><p>In cloud-native architectures, large Shuffle jobs can exert significant pressure on local disk drives, leading to issues such as insufficient disk capacity on computational nodes and higher disk random IO, thus affecting the performance and stability of large Shuffle jobs.</p><p>The industry has explored various new Shuffle technologies, including Google&#x27;s BigQuery, Baidu DCE Shuffle, Facebook&#x27;s Cosco Shuffle, Uber Zeus Shuffle, Alibaba&#x27;s Celeborn Shuffle, and many others.
Each system has made its own trade-offs based on different scenarios. Uniffle aims to create a fast, accurate, stable and cost-efficient cloud-native Remote Shuffle Service, considering performance, correctness, stability, and cost as its core aspects.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a href="#architecture" class="hash-link" aria-label="Direct link to Architecture" title="Direct link to Architecture">​</a></h2><p><img loading="lazy" alt="Architecture" src="/assets/images/architecture-19961714e3381cf27bf55e28bd212b00.png" width="1286" height="648" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="coordinator">Coordinator<a href="#coordinator" class="hash-link" aria-label="Direct link to Coordinator" title="Direct link to Coordinator">​</a></h3><p>The Coordinator is responsible for managing the entire cluster, and the Shuffle Server reports the cluster&#x27;s load situation to the Coordinator through heartbeats. Based on the cluster&#x27;s load, the Coordinator assigns suitable Shuffle Servers for jobs. To facilitate operations and maintenance, the Coordinator supports configuration deployment and provides a RESTFUL API for external access.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="shuffle-server">Shuffle Server<a href="#shuffle-server" class="hash-link" aria-label="Direct link to Shuffle Server" title="Direct link to Shuffle Server">​</a></h3><p>Shuffle Server is primarily responsible for receiving, aggregating  and writing shuffle data into storage. For shuffle data stored in local disks, Shuffle Server provides the ability to read the data.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="client">Client<a href="#client" class="hash-link" aria-label="Direct link to Client" title="Direct link to Client">​</a></h3><p>The Client is responsible for communicating with the Coordinator and Shuffle Server. It handles tasks such as requesting Shuffle Servers, sending heartbeats, and performing read and write operations on shuffle data. It provides an SDK for Spark, MapReduce and Tez to use.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="read--write-process">Read &amp; Write process<a href="#read--write-process" class="hash-link" aria-label="Direct link to Read &amp; Write process" title="Direct link to Read &amp; Write process">​</a></h2><p><img loading="lazy" alt="process" src="/assets/images/process-926f89bbddc4b91bcccbb0e3c019025c.png" width="1076" height="482" class="img_ev3q"></p><ol><li>The Driver obtains allocation information from the Coordinator.</li><li>The Driver registers Shuffle information with the Shuffle Server.</li><li>Based on the allocation information, the Executor sends Shuffle data to the Shuffle Server in the form of Blocks.</li><li>The Shuffle Server writes the data into storage.</li><li>After writing tasks completed, the Executor updates the result to the Driver.</li><li>The read task retrieves successful write task information from the Driver.</li><li>The read task retrieves Shuffle metadata (such as all blockIds) from the Shuffle Server.</li><li>Based on the storage model, the read task reads Shuffle data from the storage side.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-hybrid-storage">1) Hybrid storage<a href="#1-hybrid-storage" class="hash-link" aria-label="Direct link to 1) Hybrid storage" title="Direct link to 1) Hybrid storage">​</a></h3><p>In our internal production environment, there are Partition data blocks at the KB level which account for more than 80% of the total. In order to effectively address the random IO issues caused by these small partitions, Uniffle incorporates the concept of in-memory Shuffle, taking reference from Google&#x27;s Dremel. Additionally, considering that 80% of the data capacity in the our production environment is due to large partitions, Uniffle introduces disk and HDFS as storage media to address the data capacity problem. This forms a hybrid storage solution.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-random-io-optimization">2) Random IO Optimization<a href="#2-random-io-optimization" class="hash-link" aria-label="Direct link to 2) Random IO Optimization" title="Direct link to 2) Random IO Optimization">​</a></h3><p><img loading="lazy" alt="random_io" src="/assets/images/io_random-93469fcb7b6d912b25abeb3ec2f9b48d.png" width="840" height="552" class="img_ev3q">
The essence of random IO is the existence of numerous small data block operations. In order to avoid these operations, Uniffle first aggregates multiple MapTasks&#x27; identical partitions in the memory of the Shuffle Server to generate larger partition data. When the Shuffle data in memory reaches the partition threshold or the overall threshold, it is written into local or remote storage.
<img loading="lazy" alt="io_sort" src="/assets/images/io_sort-4e4445257d6dfd93fcbd173db1ad15ea.png" width="692" height="384" class="img_ev3q">
When the overall threshold of memory reached, Uniffle sorted the partition data in memory based on their size. Uniffle write the larger partitions to the storage media first. Additionally, when the data in memory reach to a certain size, the writing of Shuffle data to the storage media is stopped, let some data stay in the memory to further reduce random IO on the disk.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-storage-media-selection-strategy">3) Storage media selection strategy<a href="#3-storage-media-selection-strategy" class="hash-link" aria-label="Direct link to 3) Storage media selection strategy" title="Direct link to 3) Storage media selection strategy">​</a></h3><p><img loading="lazy" alt="select" src="/assets/images/select-bbfd10c777e86778f62df639415151e3.png" width="1520" height="1072" class="img_ev3q">
For writing Shuffle data to local or remote storage, Uniffle has observed through testing that larger data block sizes result in better write performance for remote storage. When the data block size exceeds 64MB, the write performance to remote storage can reach 32MB/s. It&#x27;s enough writing speed if we use multiple threads to write, comparing to the 100MB/s writing speed of HDD.Therefore, when writing data to storage media, Uniffle selects to write larger data blocks to remote storage based on their size, while smaller data blocks are written to local storage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-write-concurrency">4) Write concurrency<a href="#4-write-concurrency" class="hash-link" aria-label="Direct link to 4) Write concurrency" title="Direct link to 4) Write concurrency">​</a></h3><p>For larger partitions, it is challenging to meet the performance requirements of writing to remote storage with a single thread. In HDFS, a file can only be written by one writer. To address this limitation, Uniffle allows multiple files to be mapped to a single partition for remote storage. Uniffle utilizes multi-threading to increase the writing performance of large partitions. However, it&#x27;s important to note that a single partition occupying all remote storage threads can affect the writing performance of other partitions. Typically, there is a maximum limit on the number of concurrent write threads for a single partition. To avoid creating too many files, during the writing process, a partition will prioritize using already existing files. Only when all existing files are being written to, a new file will be created to store the data.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-data-distribution">5) Data Distribution<a href="#5-data-distribution" class="hash-link" aria-label="Direct link to 5) Data Distribution" title="Direct link to 5) Data Distribution">​</a></h3><p><img loading="lazy" alt="aqe" src="/assets/images/aqe-6090c8ed1b91b4b4892a95c69e9a1fb5.png" width="1636" height="678" class="img_ev3q">
For computational engines like Spark AQE (Adaptive Query Execution), there are scenarios where a single task needs to read only a portion of a partition&#x27;s data, as well as scenarios where multiple partitions need to be read. In the case of reading a portion of a partition&#x27;s data, if the data is randomly distributed, it can result in a significant amount of read amplification. Performing data sorting and rewriting after the data is written can lead to considerable performance loss. Therefore, Uniffle adopts a solution of partial ordering to optimize the reading of partial data. For more detailed information, please refer to <!-- -->[3]<!-- -->.
<img loading="lazy" alt="get_results" src="/assets/images/get_results-71ce542dca970bff80b6d444dbf4081c.png" width="1436" height="478" class="img_ev3q">
In scenarios where multiple partitions need to be read, an optimization technique in Uniffle involves allocating the task of reading multiple partitions to a single ShuffleServer. This allows for the aggregation of Rpc (Remote Procedure Call) requests, which means that multiple Rpc requests can be sent to a single Shuffle Server. This approach helps to minimize network overhead and improve overall performance. For more detailed information, please refer to <!-- -->[4]<!-- -->.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-off-heap-memory-management">6) Off-heap memory management<a href="#6-off-heap-memory-management" class="hash-link" aria-label="Direct link to 6) Off-heap memory management" title="Direct link to 6) Off-heap memory management">​</a></h3><p>In the data communication process of Uniffle, Grpc is used, and there are multiple memory copying processes in the Grpc code implementation. Additionally, the Shuffle Server currently uses heap memory for management. When using an 80GB memory Shuffle Server in a production environment, it may experience a significant amount of garbage collection (GC), with individual GC pauses lasting approximately 22 seconds. To address this issue, Uniffle upgraded the JDK to version 11. On the data transmission side, Uniffle refer to the communication protocol of Spark Shuffle and adopted Netty for data transfer. It also utilized ByteBuf to manage off-heap memory more efficiently.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-columnar-shuffle-format">7) Columnar Shuffle Format<a href="#7-columnar-shuffle-format" class="hash-link" aria-label="Direct link to 7) Columnar Shuffle Format" title="Direct link to 7) Columnar Shuffle Format">​</a></h3><p>The Uniffle framework itself does not natively support columnar Shuffle. To leverage the columnar Shuffle capabilities, Uniffle integrates with Gluten, a columnar shuffle component. By integrating with Gluten, Uniffle is able to reuse the columnar Shuffle capabilities provided by Gluten. For more detailed information, please refer to <!-- -->[5]<!-- -->.
<img loading="lazy" alt="Gluten" src="/assets/images/gluten-cc81f323d5ee32b7e66bacb4c092cf03.png" width="1566" height="876" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-barrier-free">8) Barrier-Free<a href="#8-barrier-free" class="hash-link" aria-label="Direct link to 8) Barrier-Free" title="Direct link to 8) Barrier-Free">​</a></h3><p>For batch processing in distributed computing frameworks, the commonly used model is the Bulk Synchronous Parallel (BSP) model. In this model, downstream tasks started after all upstream tasks have completed. However, to reduce the impact of straggler nodes on job performance, some computing frameworks support a &quot;slow start&quot; mechanism to allow upstream and downstream tasks to run concurrently. On the other hand, for stream processing and OLAP engines, a pipeline model is used where upstream and downstream tasks can run simultaneously.</p><p>To cater to various computing frameworks, Uniffle employs a barrier-free design that allows upstream and downstream stages to run concurrently. The key to achieving this barrier-free execution lies in supporting efficient in-memory read/write operations and an effective index filtering mechanism. With this design, job execution does not require a request to the Shuffle Server for writing all data to storage media at the end of each stage. Additionally, since upstream and downstream stages run simultaneously, there may be cases where downstream readers only need to read incremental data. The index filtering mechanism effectively avoids reading redundant data.</p><p>Uniffle has designed both bitmap index filtering and file index filtering mechanisms to handle in-memory and storage media data respectively. This enables Uniffle to efficiently support barrier-free execution and improve performance by avoiding redundant data reads.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-evaluation">Performance evaluation<a href="#performance-evaluation" class="hash-link" aria-label="Direct link to Performance evaluation" title="Direct link to Performance evaluation">​</a></h3><p>When using version 0.2 of Uniffle and conducting benchmarks, Uniffle&#x27;s shuffle performance is similar to Spark&#x27;s vanilla shuffle for small data volumes. However, for large data volumes, Uniffle&#x27;s shuffle outperforms Spark&#x27;s vanilla shuffle by up to 30%. The benchmark results can be found at the following link: <a href="https://github.com/apache/incubator-uniffle/blob/master/docs/benchmark.md" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-uniffle/blob/master/docs/benchmark.md</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="correctness">Correctness<a href="#correctness" class="hash-link" aria-label="Direct link to Correctness" title="Direct link to Correctness">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="metadata-verification">Metadata Verification<a href="#metadata-verification" class="hash-link" aria-label="Direct link to Metadata Verification" title="Direct link to Metadata Verification">​</a></h3><p><img loading="lazy" alt="meta" src="/assets/images/metadata-b4e7588ef03930e4cfdec890e9324e2b.png" width="1496" height="596" class="img_ev3q">
Spark reports information about all completed tasks to the driver. In the first step of the reducer, the reducer retrieves a list of task unique identifiers from the driver. Blocks are the data sent from mappers to the shuffle server, and each block has a unique identifier. The data of a block is stored in memory, on local disk, or in HDFS. To ensure data integrity, Uniffle incorporates metadata verification. Uniffle designs index files for data files stored on local disks and in HDFS. The index file contains information such as the block ID, relative offset, data checksum, compressed length, uncompressed length, and task ID. Before reading a data file, Uniffle first reads the corresponding index file. To address duplicate read issues, Uniffle uses a bitmap to keep track of the already read block IDs. By checking the block ID, Uniffle can determine if a duplicate read exists.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-verification">Data Verification<a href="#data-verification" class="hash-link" aria-label="Direct link to Data Verification" title="Direct link to Data Verification">​</a></h3><p><img loading="lazy" alt="verify" src="/assets/images/data_read-31232b8cea5323ffee089e8667ad6226.png" width="1724" height="924" class="img_ev3q">
To address data corruption issues, Uniffle performs CRC (Cyclic Redundancy Check) verification on data blocks. When reading data, Uniffle recalculates the CRC and compares it with the CRC stored in the file to determine if the data is corrupted. This helps prevent reading incorrect data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="stability">Stability<a href="#stability" class="hash-link" aria-label="Direct link to Stability" title="Direct link to Stability">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-fallback-for-hybrid-storage">1) Fallback for Hybrid storage<a href="#1-fallback-for-hybrid-storage" class="hash-link" aria-label="Direct link to 1) Fallback for Hybrid storage" title="Direct link to 1) Fallback for Hybrid storage">​</a></h3><p><img loading="lazy" alt="hdfs" src="/assets/images/hdfs_fallback-8716b86a955947ccd6243028edd3e0b6.png" width="804" height="422" class="img_ev3q">
HDFS online clusters may experience some fluctuations in stability, which can result in failures to write data to HDFS during certain time periods. In order to minimize the impact caused by HDFS fluctuations, Uniff has designed a Fallback mechanism. When writing to HDFS fails, the data will be stored locally instead, reducing the impact on the job.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-flow-control">2) Flow Control<a href="#2-flow-control" class="hash-link" aria-label="Direct link to 2) Flow Control" title="Direct link to 2) Flow Control">​</a></h3><p>Before sending a request, the job client will first request the memory resources corresponding to the data. If there is insufficient memory, the job will wait and stop sending data, thereby implementing flow control for the job.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-replication">3) Replication<a href="#3-replication" class="hash-link" aria-label="Direct link to 3) Replication" title="Direct link to 3) Replication">​</a></h3><p>Uniffle adopts the Quorum replica protocol, allowing jobs to configure the number of replicas for their data writes based on their own needs. This helps prevent stability issues caused by having only a single replica for the job.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-stage-recomputation">4) Stage Recomputation<a href="#4-stage-recomputation" class="hash-link" aria-label="Direct link to 4) Stage Recomputation" title="Direct link to 4) Stage Recomputation">​</a></h3><p>Currently, Spark supports recomputing the entire stage if there is a failure in reading from the Shuffle Server, helping the job recover and resume its execution.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-quota-management">5) Quota Management<a href="#5-quota-management" class="hash-link" aria-label="Direct link to 5) Quota Management" title="Direct link to 5) Quota Management">​</a></h3><p>When a job reaches the user&#x27;s quota limit, the Coordinator can make the job fallback to the vanilla Spark mode. This prevents from the situation that a single user&#x27;s erroneous submission of numerous jobs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-coordinator-ha">6) Coordinator HA<a href="#6-coordinator-ha" class="hash-link" aria-label="Direct link to 6) Coordinator HA" title="Direct link to 6) Coordinator HA">​</a></h3><p>Uniffle does not choose solutions like Zookeeper, Etcd, or Raft for high availability (HA) purposes, mainly considering the complexity introduced by these consensus protocol systems. For Uniffle, the Coordinator is stateless and does not persist any state. All state information is reported by the Shuffle Server through heartbeats, so there is no need to determine which node is the master. Deploying multiple Coordinator instances ensures high availability of the service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cost-effective">Cost Effective<a href="#cost-effective" class="hash-link" aria-label="Direct link to Cost Effective" title="Direct link to Cost Effective">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-low-cost-remote-storage">1) Low-Cost Remote Storage<a href="#1-low-cost-remote-storage" class="hash-link" aria-label="Direct link to 1) Low-Cost Remote Storage" title="Direct link to 1) Low-Cost Remote Storage">​</a></h3><p>In general, for a relatively stable business, computational resources tend to remain stable while storage resources grow linearly. These storage resources store a large amount of cold data. Uniffle supports hybrid storage, which allows the utilization of these unused storage resources, thereby reducing the overall system cost.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-automatic-scaling">2) Automatic Scaling<a href="#2-automatic-scaling" class="hash-link" aria-label="Direct link to 2) Automatic Scaling" title="Direct link to 2) Automatic Scaling">​</a></h3><p>Uniffle has developed a K8S Operator that implements scaling operations for stateful services using webhooks. By leveraging Horizontal Pod Autoscaler (HPA), automatic scaling can be achieved, further reducing system costs.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="community-engagement">Community Engagement<a href="#community-engagement" class="hash-link" aria-label="Direct link to Community Engagement" title="Direct link to Community Engagement">​</a></h2><p>Currently, Uniffle supports multiple computational frameworks such as Spark, MapReduce, and Tez.</p><p>Uniffle Spark has been adopted by companies like Tencent, Didi, iQiyi, SF Express, and Vipshop, handling PB-level data on a daily basis.</p><p>Uniffle MapReduce is employed in mixed deployment scenarios by companies like Bilibili and Zhihu</p><p>Uniffle Tez has been jointly developed by HuoLaLa, Beike, and Shein.</p><p>The development of many important features in the community has involved contributions from well-known Chinese internet companies.
For example, iQiyi has contributed support for accessing Kerberos HDFS clusters and has optimized the performance of Spark AQE on Uniffle.Didi has added support for multi-tenant job quotas. Netty data plane optimizations were jointly completed by Didi and Vipshop.The support for Gluten was contributed by Baidu and SF Express.</p><p>Currently, the community has more than 50 contributors, with over 600 commits, and has released four Apache versions. It is being used by dozens of companies. Additionally, teams and companies interested in contributing to Uniffle Flink can contact the Uniffle community at mailto:<a href="mailto:dev@uniffle.apache.org" target="_blank" rel="noopener noreferrer">dev@uniffle.apache.org</a>.</p><p>Currently, there are no companies participating in the community with deployment scenarios or development plans for Uniffle Flink. Your help in filling this gap in the community would be greatly appreciated. Uniffle&#x27;s design incorporates a large number of mechanisms and strategies, and users are welcome to contribute strategies that suit their own scenarios.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="future-plans">Future Plans<a href="#future-plans" class="hash-link" aria-label="Direct link to Future Plans" title="Direct link to Future Plans">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-optimization">Storage Optimization<a href="#storage-optimization" class="hash-link" aria-label="Direct link to Storage Optimization" title="Direct link to Storage Optimization">​</a></h3><ol><li>Integration with object storage to optimize system costs.</li><li>Merging index files and data files to further reduce IO overhead.</li><li>Support for heterogeneous storage resources such as SSD and HDD.</li><li>Support for sorting data by key.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="computation-optimization">Computation Optimization<a href="#computation-optimization" class="hash-link" aria-label="Direct link to Computation Optimization" title="Direct link to Computation Optimization">​</a></h3><ol><li>Support for dynamic allocation of Shuffle Servers.</li><li>Partial support for Slow Start feature in some engines.</li><li>Continuous optimizations for Spark AQE.</li><li>Support for the Flink engine.</li><li>Asynchronous data reading support for compute engines.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2><p>Uniffle has been designed with a focus on performance, correctness, stability, and cost-effectiveness, making it a suitable Shuffle system for cloud-native architectures. We welcome everyone to contribute to the Uniffle project. The Uniffle project can be found at <a href="https://github.com/apache/incubator-uniffle" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-uniffle</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="reference">Reference<a href="#reference" class="hash-link" aria-label="Direct link to Reference" title="Direct link to Reference">​</a></h2><p>[1]<!-- --> <a href="https://cloud.tencent.com/developer/article/1903023" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1903023</a></p><p>[2]<!-- --> <a href="https://cloud.tencent.com/developer/article/1943179" target="_blank" rel="noopener noreferrer">https://cloud.tencent.com/developer/article/1943179</a></p><p>[3]<!-- --> <a href="https://github.com/apache/incubator-uniffle/pull/137" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-uniffle/pull/137</a></p><p>[4]<!-- --> <a href="https://github.com/apache/incubator-uniffle/pull/307" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-uniffle/pull/307</a></p><p>[5]<!-- --> <a href="https://github.com/apache/incubator-uniffle/pull/950" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-uniffle/pull/950</a></p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-uniffle/blog/2023-07-21/Uniffle - New chapter for the shuffle in the cloud native era.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2023/01/09/2022 summary"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">2022 summary</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#coordinator" class="table-of-contents__link toc-highlight">Coordinator</a></li><li><a href="#shuffle-server" class="table-of-contents__link toc-highlight">Shuffle Server</a></li><li><a href="#client" class="table-of-contents__link toc-highlight">Client</a></li></ul></li><li><a href="#read--write-process" class="table-of-contents__link toc-highlight">Read &amp; Write process</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a><ul><li><a href="#1-hybrid-storage" class="table-of-contents__link toc-highlight">1) Hybrid storage</a></li><li><a href="#2-random-io-optimization" class="table-of-contents__link toc-highlight">2) Random IO Optimization</a></li><li><a href="#3-storage-media-selection-strategy" class="table-of-contents__link toc-highlight">3) Storage media selection strategy</a></li><li><a href="#4-write-concurrency" class="table-of-contents__link toc-highlight">4) Write concurrency</a></li><li><a href="#5-data-distribution" class="table-of-contents__link toc-highlight">5) Data Distribution</a></li><li><a href="#6-off-heap-memory-management" class="table-of-contents__link toc-highlight">6) Off-heap memory management</a></li><li><a href="#7-columnar-shuffle-format" class="table-of-contents__link toc-highlight">7) Columnar Shuffle Format</a></li><li><a href="#8-barrier-free" class="table-of-contents__link toc-highlight">8) Barrier-Free</a></li><li><a href="#performance-evaluation" class="table-of-contents__link toc-highlight">Performance evaluation</a></li></ul></li><li><a href="#correctness" class="table-of-contents__link toc-highlight">Correctness</a><ul><li><a href="#metadata-verification" class="table-of-contents__link toc-highlight">Metadata Verification</a></li><li><a href="#data-verification" class="table-of-contents__link toc-highlight">Data Verification</a></li></ul></li><li><a href="#stability" class="table-of-contents__link toc-highlight">Stability</a><ul><li><a href="#1-fallback-for-hybrid-storage" class="table-of-contents__link toc-highlight">1) Fallback for Hybrid storage</a></li><li><a href="#2-flow-control" class="table-of-contents__link toc-highlight">2) Flow Control</a></li><li><a href="#3-replication" class="table-of-contents__link toc-highlight">3) Replication</a></li><li><a href="#4-stage-recomputation" class="table-of-contents__link toc-highlight">4) Stage Recomputation</a></li><li><a href="#5-quota-management" class="table-of-contents__link toc-highlight">5) Quota Management</a></li><li><a href="#6-coordinator-ha" class="table-of-contents__link toc-highlight">6) Coordinator HA</a></li></ul></li><li><a href="#cost-effective" class="table-of-contents__link toc-highlight">Cost Effective</a><ul><li><a href="#1-low-cost-remote-storage" class="table-of-contents__link toc-highlight">1) Low-Cost Remote Storage</a></li><li><a href="#2-automatic-scaling" class="table-of-contents__link toc-highlight">2) Automatic Scaling</a></li></ul></li><li><a href="#community-engagement" class="table-of-contents__link toc-highlight">Community Engagement</a></li><li><a href="#future-plans" class="table-of-contents__link toc-highlight">Future Plans</a><ul><li><a href="#storage-optimization" class="table-of-contents__link toc-highlight">Storage Optimization</a></li><li><a href="#computation-optimization" class="table-of-contents__link toc-highlight">Computation Optimization</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/the-asf/shared_invite/zt-1fm9561yr-uzTpjqg3jf5nxSJV5AE3KQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-uniffle/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/apache/incubator-uniffle" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://incubator.apache.org/" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/apache-incubator.svg" alt="Apache Incubator logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright"><div style="text-align: left;">
          <div>
            <p style="font-family: Avenir-Medium;font-size: 14px;color: #999;line-height: 20px;"> Apache Uniffle (Incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. </p>
          </div>
          <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright © 2025 The Apache Software Foundation. Apache Uniffle (Incubating), Uniffle, and its feather logo are trademarks of The Apache Software Foundation.</span></div>
        </div></div></div></div></footer></div>
<script src="/assets/js/runtime~main.3cf157ce.js"></script>
<script src="/assets/js/main.1b249127.js"></script>
</body>
</html>